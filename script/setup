#!/usr/bin/env bash -e

log() { echo -e "\033[0;35m${1}\033[0m"; }

DOTFILESDIRREL=$(dirname $0)
cd $DOTFILESDIRREL/..
DOTFILESDIR=$(pwd -P)

log 'Installing dotfiles'
for DOTFILE in *; do
  HOMEFILE="$HOME/.$DOTFILE"
  [ -d $DOTFILE ] && DOTFILE="$DOTFILE/"
  DIRFILE="$DOTFILESDIR/$DOTFILE"

  echo $DOTFILE | egrep -q '(^script/$|\.txt$|\.md$)' && continue
  echo $DOTFILE | grep -q 'vscode-settings' &&
       HOMEFILE="$HOME/Library/Application Support/Code/User/settings.json" &&
       mkdir -p "$HOME/Library/Application Support/Code/User"

  echo $DOTFILE | grep -q '\.sh' &&
       HOMEFILE="$HOME/.$(echo $DOTFILE | sed -e 's/\.sh//')"

  if [ -L "$HOMEFILE" ] && ! [ -d $DOTFILE ]
  then
    ln -sfv "$DIRFILE" "$HOMEFILE"
  else
    rm -rv "$HOMEFILE"
    ln -sv "$DIRFILE" "$HOMEFILE"
  fi
done

log 'Running accessory scripts'
script/extract-onepassword-secrets
script/install-vscode-extensions
script/defaults
script/dock
script/terminal

log 'Setting default shell to zsh'
if [ "$SHELL" != '/usr/local/bin/zsh' ]
then
  sudo chsh -s '/usr/local/bin/zsh' $USER
fi
